@model AIRecommendationViewModel
@{
    ViewData["Title"] = "AI Fitness Önerisi";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Başlık -->
            <div class="text-center mb-5">
                <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                    <i class="bi bi-robot text-primary" style="font-size: 2.5rem;"></i>
                </div>
                <h1 class="section-title">AI Fitness Asistanı</h1>
                <p class="text-muted">Kişisel bilgilerinize göre size özel egzersiz ve beslenme önerisi alın</p>
            </div>

            <div class="row g-4">
                <!-- Form -->
                <div class="col-lg-5">
                    <div class="card shadow-sm h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Bilgileriniz</h5>
                        </div>
                        <div class="card-body">
                            <form asp-action="Recommendation" method="post" id="aiForm">
                                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                                <!-- Temel Bilgiler -->
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label asp-for="Age" class="form-label"></label>
                                        <input asp-for="Age" class="form-control" type="number" min="10" max="100" placeholder="25" />
                                        <span asp-validation-for="Age" class="text-danger small"></span>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label asp-for="Gender" class="form-label"></label>
                                        <select asp-for="Gender" class="form-select">
                                            <option value="">Seçin</option>
                                            <option value="Erkek">Erkek</option>
                                            <option value="Kadın">Kadın</option>
                                        </select>
                                        <span asp-validation-for="Gender" class="text-danger small"></span>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label asp-for="Height" class="form-label"></label>
                                        <div class="input-group">
                                            <input asp-for="Height" class="form-control" type="number" min="100" max="250" placeholder="175" />
                                            <span class="input-group-text">cm</span>
                                        </div>
                                        <span asp-validation-for="Height" class="text-danger small"></span>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label asp-for="Weight" class="form-label"></label>
                                        <div class="input-group">
                                            <input asp-for="Weight" class="form-control" type="number" step="0.1" min="30" max="300" placeholder="70" />
                                            <span class="input-group-text">kg</span>
                                        </div>
                                        <span asp-validation-for="Weight" class="text-danger small"></span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="BodyType" class="form-label"></label>
                                    <select asp-for="BodyType" class="form-select">
                                        <option value="">Seçin</option>
                                        <option value="Ektomorf">Ektomorf (İnce yapılı, zor kilo alır)</option>
                                        <option value="Mezomorf">Mezomorf (Atletik, kolay kas yapar)</option>
                                        <option value="Endomorf">Endomorf (Geniş yapılı, kolay kilo alır)</option>
                                    </select>
                                    <span asp-validation-for="BodyType" class="text-danger small"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Goal" class="form-label"></label>
                                    <select asp-for="Goal" class="form-select">
                                        <option value="">Seçin</option>
                                        <option value="Kilo Vermek">Kilo Vermek</option>
                                        <option value="Kilo Almak">Kilo Almak</option>
                                        <option value="Kas Yapmak">Kas Yapmak</option>
                                        <option value="Fit Kalmak">Fit Kalmak</option>
                                        <option value="Esneklik Kazanmak">Esneklik Kazanmak</option>
                                    </select>
                                    <span asp-validation-for="Goal" class="text-danger small"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="ActivityLevel" class="form-label"></label>
                                    <select asp-for="ActivityLevel" class="form-select">
                                        <option value="">Seçin</option>
                                        <option value="Sedanter">Sedanter (Hareketsiz)</option>
                                        <option value="Hafif Aktif">Hafif Aktif (Haftada 1-2 gün)</option>
                                        <option value="Orta Aktif">Orta Aktif (Haftada 3-4 gün)</option>
                                        <option value="Çok Aktif">Çok Aktif (Haftada 5+ gün)</option>
                                    </select>
                                    <span asp-validation-for="ActivityLevel" class="text-danger small"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="HealthIssues" class="form-label"></label>
                                    <textarea asp-for="HealthIssues" class="form-control" rows="2" placeholder="Varsa belirtin (örn: bel fıtığı, diz sorunu)"></textarea>
                                    <span asp-validation-for="HealthIssues" class="text-danger small"></span>
                                </div>

                                <button type="submit" class="btn btn-primary w-100 py-2" id="submitBtn">
                                    <i class="bi bi-magic me-2"></i>Öneri Al
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Sonuç -->
                <div class="col-lg-7">
                    @if (Model.Recommendation != null)
                    {
                        <!-- BMI Kartı -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-6 text-center border-end">
                                        <h6 class="text-muted mb-1">Vücut Kitle İndeksi (BMI)</h6>
                                        <h2 class="text-primary mb-1">@Model.BMI</h2>
                                        <span class="badge @(Model.BMICategory == "Normal" ? "bg-success" : Model.BMICategory == "Zayıf" ? "bg-warning" : "bg-danger") fs-6">
                                            @Model.BMICategory
                                        </span>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <h6 class="text-muted mb-2">BMI Skalası</h6>
                                        <div class="small">
                                            <span class="badge bg-warning me-1">&lt;18.5 Zayıf</span>
                                            <span class="badge bg-success me-1">18.5-25 Normal</span>
                                            <span class="badge bg-danger">25+ Fazla</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Dönüşüm Görseli -->
                        @if (!string.IsNullOrEmpty(Model.TransformationImageUrl))
                        {
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-image me-2"></i>Hedef Görünümünüz
                                    </h5>
                                </div>
                                <div class="card-body text-center">
                                    <p class="text-muted mb-3">
                                        <i class="bi bi-magic me-1"></i>
                                        "@Model.Goal" hedefinize ulaştığınızda yaklaşık olarak bu görünüme kavuşabilirsiniz:
                                    </p>
                                    <div class="position-relative d-inline-block">
                                        <img src="@Model.TransformationImageUrl"
                                             alt="Hedef Dönüşüm Görseli"
                                             class="img-fluid rounded shadow"
                                             style="max-height: 400px; object-fit: cover;"
                                             id="transformationImage"
                                             onerror="this.onerror=null; this.src='https://via.placeholder.com/512x512?text=Görsel+Yükleniyor...';">
                                        <div id="imageLoader" class="position-absolute top-50 start-50 translate-middle">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Yükleniyor...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-clock me-1"></i>
                                            Tahmini süre: @GetEstimatedTime(Model) ay düzenli antrenman
                                        </span>
                                    </div>
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Bu görsel yapay zeka tarafından oluşturulmuştur ve motivasyon amaçlıdır.
                                    </p>
                                </div>
                            </div>
                        }

                    @functions {
                        string GetEstimatedTime(AIRecommendationViewModel m)
                        {
                            if (m.Goal == null) return "3-6";

                            return m.Goal.ToLower() switch
                            {
                                "kilo vermek" => m.BMI > 30 ? "4-8" : "2-4",
                                "kilo almak" => "3-6",
                                "kas yapmak" => "6-12",
                                "fit kalmak" => "1-3",
                                "esneklik kazanmak" => "2-4",
                                _ => "3-6"
                            };
                        }
                    }


                        <!-- AI Önerisi -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-lightbulb me-2"></i>Kişisel Öneri Planınız
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="recommendation-content">
                                    @Html.Raw(Model.Recommendation.Replace("\n", "<br>").Replace("## ", "<h5 class='mt-4 mb-3 text-primary'>").Replace("**", "<strong>").Replace("🔹", "<br>🔹"))
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>Bu öneriler genel bilgi amaçlıdır. Detaylı plan için uzman desteği alın.
                                    </small>
                                    <a asp-controller="Appointment" asp-action="Create" class="btn btn-sm btn-primary">
                                        <i class="bi bi-calendar-plus me-1"></i>Randevu Al
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Boş Durum -->
                        <div class="card shadow-sm h-100">
                            <div class="card-body d-flex flex-column align-items-center justify-content-center text-center py-5">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mb-4" style="width: 120px; height: 120px;">
                                    <i class="bi bi-clipboard2-pulse text-primary" style="font-size: 3rem;"></i>
                                </div>
                                <h4>Kişisel Fitness Öneriniz</h4>
                                <p class="text-muted mb-4">
                                    Sol taraftaki formu doldurarak yapay zeka destekli<br>
                                    kişisel egzersiz ve beslenme önerinizi alın.
                                </p>
                                <div class="row g-3 w-100">
                                    <div class="col-md-4">
                                        <div class="bg-light rounded p-3">
                                            <i class="bi bi-activity text-success d-block mb-2" style="font-size: 1.5rem;"></i>
                                            <small>Egzersiz Programı</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="bg-light rounded p-3">
                                            <i class="bi bi-egg-fried text-warning d-block mb-2" style="font-size: 1.5rem;"></i>
                                            <small>Beslenme Önerisi</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="bg-light rounded p-3">
                                            <i class="bi bi-graph-up-arrow text-info d-block mb-2" style="font-size: 1.5rem;"></i>
                                            <small>Kalori Hesabı</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .recommendation-content h5 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        .recommendation-content strong {
            color: var(--secondary-color);
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Form gönderilirken loading göster
        document.getElementById('aiForm')?.addEventListener('submit', function() {
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analiz Ediliyor...';
            btn.disabled = true;
        });

        // Resim yüklendiğinde loader'ı gizle
        const img = document.getElementById('transformationImage');
        const loader = document.getElementById('imageLoader');

        if (img && loader) {
            img.onload = function() {
                loader.style.display = 'none';
            };

            // 10 saniye sonra hala yüklenmediyse loader'ı gizle
            setTimeout(function() {
                if (loader) loader.style.display = 'none';
            }, 10000);
        }
    </script>
}